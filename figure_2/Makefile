.DELETE_ON_ERROR: # If an error occurs, files generated by makefile will be deleted

### FIGURE 1 ###

# R packages: Tidyverse, survival, IPDfromKM, survminer, flexsurv,
#						  readxl, furrr, oce (only necessary if isosurface file
# 					  needs to be created)


# List all target files, that this makefile should generate
all : ../model/tumormodel \
		data/data_grid_microsimulation.RData \
		plots/figure_1.pdf


../model/tumormodel : ../model/model.cpp
	cd ../model && make

################################################################################
#### Figure 1A: Original (=digitized) data ####
################################################################################

# The following three panels between the #### create panel A of figure 1.
# First, a RData file is created which contains the information to plot
# the survival curve, and subsequently the plot is created.

#### Figure 1A - panel 1 (plot of NCCTG data) ####
data/figure_1a_KM_NCCTG.RData : scripts/figure_1a_data.R
	Rscript $<

plots/plot_lung_ncctg.pdf : scripts/plot_lung_ncctg.R \
															data/figure_1a_KM_NCCTG.RData \
															../misc/theme.R
	Rscript $<
##################################################

#### Figure 1A - panel 2 (plot of CA184-024 trial - Ipilimumab) ####
data/figure_1b_KM_melanoma.RData : scripts/figure_1b_data.R \
																	 data/ipi_placebo_digitized.xlsx
	Rscript $<

plots/figure_1b_ipi_placebo.pdf : scripts/figure_1b_plot.R \
														      data/figure_1b_KM_melanoma.RData \
														      ../misc/theme.R
	Rscript $<
##################################################

#### Figure 1A - panel 3 (plot of Checkmate 066 - Nivolumab)
data/figure_1c_KM_melanoma.RData : scripts/figure_1c_data.R \
																	 data/nivo_dacarb_digitized.xlsx
	Rscript $<

plots/figure_1c_dtic_nivo.pdf : scripts/figure_1c_plot.R \
														    data/figure_1c_KM_melanoma.RData \
														    ../misc/theme.R
	Rscript $<
############################################################



################################################################################
#### Figure 1B: Microsimulation data ####
################################################################################

# Create a grid of all possible combinations of three parameters and calculate
# the OS for each combination.
# Note: data also provided.
#data/data_grid_microsimulation.RData : scripts/data_grid_microsimulation.R \
																			 ../model/call_model_function.R
#	Rscript $<

# Extract the isosurface of the grid
# Note: data also provided.
#data/isosurface.RData : scripts/extract_isosurface.R \
												data/data_grid_microsimulation.RData
#	Rscript $<

#### Figure 1B - panel 1: Microsimulation of figure 1A panel 1 ####
data/figure_1d_data.RData : scripts/figure_1d_data.R \
														scripts/survival_to_param_function.R \
														../model/call_model_function.R \
														data/figure_1a_KM_NCCTG.RData \
														data/isosurface.RData
	Rscript $<

plots/figure_1d.pdf : scripts/figure_1d_plot.R \
											data/figure_1d_data.RData \
											../misc/theme.R
	Rscript $<
####################################################################

#### Figure 1B - panel 2: Microsimulation of figure 1A panel 2 ####
data/figure_1e_data.RData : scripts/figure_1e_data.R \
														scripts/survival_to_param_function.R \
														../model/call_model_function.R \
														data/figure_1b_KM_melanoma.RData \
														data/isosurface.RData
	Rscript $<

plots/figure_1e.pdf : scripts/figure_1e_plot.R \
											data/figure_1e_data.RData \
											../misc/theme.R
	Rscript $<
####################################################################

#### Figure 1B - panel 3: Microsimulation of figure 1A panel 3 ####
data/figure_1f_data.RData : scripts/figure_1f_data.R \
														scripts/survival_to_param_function.R \
														../model/call_model_function.R \
														data/figure_1c_KM_melanoma.RData \
														data/isosurface.RData
	Rscript $<

plots/figure_1f.pdf : scripts/figure_1f_plot.R \
											../misc/theme.R \
											data/figure_1f_data.RData
	Rscript $<
###################################################################



plots/figure_1.pdf : scripts/figure_1.tex \
											plots/plot_lung_ncctg.pdf \
											plots/figure_1b_ipi_placebo.pdf \
											plots/figure_1c_dtic_nivo.pdf \
											plots/figure_1d.pdf \
											plots/figure_1e.pdf \
											plots/figure_1f.pdf
	pdflatex -output-directory=plots/ $<


clean :
	rm plots/figure_1.aux \
	plots/figure_1.log \
	Rplots.pdf
